name: "CI/CD Pipeline (modulaire : back/front + couverture systématique)"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      run_backend:
        description: 'Run backend job'
        required: false
        default: false
        type: boolean
      run_frontend:
        description: 'Run frontend job'
        required: false
        default: false
        type: boolean
      force_all_coverage:
        description: 'Force run both jobs (generate coverage for both)'
        required: false
        default: false
        type: boolean

env:
  DOCKERHUB_USERNAME: emysim
  BACKEND_IMAGE: emysim/bobapp-backend
  FRONTEND_IMAGE: emysim/bobapp-frontend

jobs:
  # 1) Detect changes once and export outputs for other jobs
  detect:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            backend:
              - 'back/**'
            frontend:
              - 'front/**'

  # 2) Backend job — runs when backend changed OR when manually requested OR when force_all_coverage
  backend:
    needs: detect
    runs-on: ubuntu-latest
    if: needs.detect.outputs.backend == 'true' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.run_backend == 'true' || github.event.inputs.force_all_coverage == 'true'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup JDK (Java 17)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Backend - Build & Test with Coverage
        working-directory: back
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          mvn -B clean verify jacoco:report
          ls -R target || true

      - name: Upload Backend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: back/target/site/jacoco/
          retention-days: 7

  # 3) Frontend job — runs when frontend changed OR when manually requested OR when force_all_coverage
  frontend:
    needs: detect
    runs-on: ubuntu-latest
    if: needs.detect.outputs.frontend == 'true' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.run_frontend == 'true' || github.event.inputs.force_all_coverage == 'true'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'front/package-lock.json'

      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: front/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('front/package-lock.json') }}

      - name: Frontend - Install dependencies
        working-directory: front
        run: npm install -g @angular/cli

      - name: Frontend - Run tests with coverage
        working-directory: front
        env:
          CI: true
        run: npm run test:ci

      - name: Upload Frontend Coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: front/coverage/
          retention-days: 7